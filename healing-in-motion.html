<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Healing in Motion | Survivor Stories | Coffee & Connections</title>
  
  <meta name="description" content="A digital sanctuary for survivor stories. Read, reflect, and find hope in the journey of recovery." />

  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Merriweather:ital,wght@0,300;1,400&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/(00)base.css">
  <link rel="stylesheet" href="css/(00)header-footer.css">
  <link rel="stylesheet" href="css/(00)navigation.css">
  <link rel="stylesheet" href="css/(05)healing-in-motion.css"> 
  
  <script src="js/config.js"></script>
</head>

<body>

<nav class="nav-container" role="navigation">
  <ul class="nav-menu">
    <li><a href="index.html">üè† Home</a></li>
    <li><a href="menu.html">‚òï Coffee</a></li>
    <li><a href="our-mission.html">üí¨ Mission</a></li>
    <li><a href="resilience-market.html">üõçÔ∏è Shop</a></li>
  </ul>
</nav>

<main>

    <section class="preamble-section">
      <h1 class="preamble-title">The Language of Healing</h1>
      <p class="preamble-text">
        In this space, words matter. While "victim" is a legal term, we choose <strong>"Survivor."</strong> 
        These are their pages. This is their truth.
      </p>
    </section>

    <div class="book-container" id="journalBook">
      <div class="journal-spread active" id="spread-0">
        <div class="page left">
          <div class="title-page-content">
            <h2 class="book-main-title">The<br>Survivor<br>Journal</h2>
            <div style="font-size: 2rem; color: #8d6e63;">‚ù¶</div>
            <p>Est. 2025 ‚Ä¢ El Paso</p>
          </div>
        </div>
        <div class="page right">
          <div class="dedication">
            <p>"Your stories aren‚Äôt chapters ‚Äî they‚Äôre declarations."</p>
            <br>
            <p>Declarations that trauma doesn‚Äôt define you. That healing is radical. That survival is sacred.</p>
          </div>
        </div>
      </div>
      </div>

    <div class="book-controls">
      <button id="prevBtn" class="control-btn" disabled>‚Üê Previous Page</button>
      <button id="nextBtn" class="control-btn">Next Page ‚Üí</button>
    </div>

    <section class="form-section">
      <div class="form-container">
        <h2 style="font-family: 'Cormorant Garamond', serif; margin-bottom: 1rem;">Lend Your Voice</h2>
        
        <div class="disclaimer-box">
            <strong>‚ö†Ô∏è Safety First:</strong> This is a public space. Please do not use your real name unless you are comfortable doing so. 
            Do not include names of others or identifiable details. We protect your story, but you must protect your identity.
        </div>
        
        <form id="storyForm">
          <label>Name / Alias (Optional)</label>
          <input type="text" id="alias" class="form-input" placeholder="e.g. 'Jane D.' or 'Anonymous'">
          
          <label>Your Story</label>
          <textarea id="message" rows="6" class="form-textarea" required placeholder="Speak your truth..."></textarea>

          <label>Primary Theme</label>
          <select id="tags" class="form-select" required>
            <option value="" disabled selected>Select a Category...</option>
            <option value="MH">Mental Health</option>
            <option value="DV">Domestic Violence</option>
            <option value="PTSD">PTSD</option>
            <option value="MST">Military Sexual Trauma (MST)</option>
            <option value="SUI">Suicide Prevention/Survivor</option>
            <option value="SUD">Substance Abuse Disorder</option>
          </select>
          
          <button type="submit" class="submit-btn">Add My Story</button>
        </form>
      </div>
    </section>

</main>

<footer>
  <p>¬© <span id="year">2026</span> Coffee & Connections El Paso</p>
</footer>

<script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // MAP TAG CODES TO FULL NAMES FOR DISPLAY
    const TAG_MAP = {
        'MH': 'Mental Health',
        'DV': 'Domestic Violence',
        'PTSD': 'PTSD',
        'MST': 'Military Sexual Trauma',
        'SUI': 'Suicide Prevention',
        'SUD': 'Substance Abuse Disorder'
    };

    // 1. SUBMIT STORY LOGIC
    document.getElementById('storyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.querySelector('.submit-btn');
        const originalText = btn.innerText;
        btn.innerText = "Sending to Secure Vault...";
        btn.disabled = true;

        const storyData = {
            alias: document.getElementById('alias').value || "Anonymous",
            message: document.getElementById('message').value,
            tags: [document.getElementById('tags').value] // Send as array ["DV"]
        };

        try {
            // CALL THE VAULT (Port 6000)
            const res = await fetch(CONFIG.endpoints.submitStory, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(storyData)
            });

            if (res.ok) {
                alert("Thank you. Your story has been securely received and will appear in the journal shortly.");
                document.getElementById('storyForm').reset();
                btn.innerText = "Story Submitted";
            } else {
                throw new Error("Server rejected submission");
            }
        } catch (err) {
            console.error(err);
            alert("Connection Error: Could not reach the Secure Vault. Please try again later.");
            btn.innerText = originalText;
            btn.disabled = false;
        }
    });

    // 2. FETCH STORIES & BUILD BOOK
    async function loadJournal() {
        try {
            // GET APPROVED STORIES
            const res = await fetch(CONFIG.endpoints.getStories);
            const stories = await res.json();
            
            const bookContainer = document.getElementById('journalBook');
            
            // Loop through stories in pairs (2 per spread)
            for (let i = 0; i < stories.length; i += 2) {
                const storyLeft = stories[i];
                const storyRight = stories[i + 1]; // Might be undefined if odd number

                const spreadDiv = document.createElement('div');
                spreadDiv.className = 'journal-spread';
                spreadDiv.id = `spread-${(i/2) + 1}`;

                // Helper to generate Page HTML
                const createPage = (story, pageNum, side) => {
                    if (!story) return `<div class="page ${side}"><div class="dedication"><p>...</p></div></div>`;
                    
                    // Get CSS class for tag color (e.g., 'tag-dv')
                    const tagCode = story.tags[0] || 'misc';
                    const tagName = TAG_MAP[tagCode] || tagCode;
                    const tagClass = `tag-${tagCode.toLowerCase()}`;

                    return `
                        <div class="page ${side}">
                            <span class="page-num">${pageNum}</span>
                            <h3 class="entry-title">${story.alias}</h3>
                            <p class="entry-text">${story.message}</p>
                            <div class="signature">‚Äî Survivor</div>
                            <div class="tags-container">
                                <span class="tag ${tagClass}">${tagName}</span>
                            </div>
                        </div>
                    `;
                };

                spreadDiv.innerHTML = createPage(storyLeft, i + 2, 'left') + 
                                      createPage(storyRight, i + 3, 'right');
                
                bookContainer.appendChild(spreadDiv);
            }
            
            initPageTurning(); // Re-bind buttons

        } catch (err) {
            console.error("Journal Load Error:", err);
            // If offline, book stays on Title Page (graceful failure)
        }
    }

    // 3. PAGE TURNING
    function initPageTurning() {
        const spreads = document.querySelectorAll('.journal-spread');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        let currentSpread = 0;

        function updateBook() {
            spreads.forEach((spread, index) => {
                if (index === currentSpread) spread.classList.add('active');
                else spread.classList.remove('active');
            });
            prevBtn.disabled = (currentSpread === 0);
            nextBtn.disabled = (currentSpread === spreads.length - 1);
        }

        nextBtn.onclick = () => {
            if (currentSpread < spreads.length - 1) {
                currentSpread++;
                updateBook();
            }
        };

        prevBtn.onclick = () => {
            if (currentSpread > 0) {
                currentSpread--;
                updateBook();
            }
        };
    }

    // START
    loadJournal();

</script>

</body>
</html>
